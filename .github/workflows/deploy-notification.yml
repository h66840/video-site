name: Cross-Repository Deployment Notification

# è§¦å‘æ¡ä»¶ï¼šå½“ä¸»åˆ†æ”¯æœ‰æ–°çš„pushæ—¶
on:
  push:
    branches: [ main, master ]

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: read

jobs:
  create-deployment-issue:
    runs-on: ubuntu-latest
    name: Create Deployment Notification Issue
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get commit information
      id: commit-info
      run: |
        echo "commit_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
        echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
        echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
        echo "commit_date=$(git log -1 --pretty=%ci)" >> $GITHUB_OUTPUT
        echo "repo_name=${GITHUB_REPOSITORY}" >> $GITHUB_OUTPUT
        
    - name: Create deployment notification issue
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.CROSS_REPO_TOKEN }}
        script: |
          const issueTitle = `ðŸš€ Deployment Notification from ${context.repo.repo}`;
          const issueBody = `
          ## éƒ¨ç½²é€šçŸ¥ / Deployment Notification
          
          **æºä»“åº“ / Source Repository:** \`${{ steps.commit-info.outputs.repo_name }}\`
          
          **è§¦å‘äº‹ä»¶ / Trigger Event:** æ–°çš„commitæŽ¨é€åˆ°ä¸»åˆ†æ”¯
          
          ### ðŸ“‹ Commitè¯¦æƒ… / Commit Details
          - **Commit SHA:** \`${{ steps.commit-info.outputs.commit_sha }}\`
          - **æäº¤ä¿¡æ¯ / Commit Message:** ${{ steps.commit-info.outputs.commit_message }}
          - **æäº¤ä½œè€… / Author:** ${{ steps.commit-info.outputs.commit_author }}
          - **æäº¤æ—¶é—´ / Date:** ${{ steps.commit-info.outputs.commit_date }}
          
          ### ðŸ”— ç›¸å…³é“¾æŽ¥ / Related Links
          - [æŸ¥çœ‹Commit / View Commit](https://github.com/${{ steps.commit-info.outputs.repo_name }}/commit/${{ steps.commit-info.outputs.commit_sha }})
          - [æºä»“åº“ / Source Repository](https://github.com/${{ steps.commit-info.outputs.repo_name }})
          
          ### âš¡ è‡ªåŠ¨åŒ–ä¿¡æ¯ / Automation Info
          - **å·¥ä½œæµ / Workflow:** \`${{ github.workflow }}\`
          - **è¿è¡ŒID / Run ID:** \`${{ github.run_id }}\`
          - **è§¦å‘æ—¶é—´ / Triggered At:** \`${{ github.event.head_commit.timestamp }}\`
          
          ---
          
          > ðŸ¤– æ­¤issueç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º
          > ðŸ¤– This issue was automatically created by GitHub Actions
          
          **ä¸‹ä¸€æ­¥æ“ä½œå»ºè®® / Suggested Next Steps:**
          - [ ] æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
          - [ ] éªŒè¯åŠŸèƒ½æ­£å¸¸
          - [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£
          - [ ] é€šçŸ¥ç›¸å…³å›¢é˜Ÿæˆå‘˜
          `;
          
          try {
            const response = await github.rest.issues.create({
              owner: 'h66840',
              repo: 'my-new-proj',
              title: issueTitle,
              body: issueBody,
              labels: ['deployment', 'automation', 'notification']
            });
            
            console.log(\`âœ… Successfully created issue #\${response.data.number}\`);
            console.log(\`ðŸ”— Issue URL: \${response.data.html_url}\`);
            
            // è®¾ç½®è¾“å‡ºå˜é‡ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
            core.setOutput('issue-number', response.data.number);
            core.setOutput('issue-url', response.data.html_url);
            
          } catch (error) {
            console.error('âŒ Failed to create issue:', error);
            core.setFailed(\`Failed to create deployment notification issue: \${error.message}\`);
          }
          
    - name: Summary
      run: |
        echo "## ðŸŽ‰ éƒ¨ç½²é€šçŸ¥å·²åˆ›å»º / Deployment Notification Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æºä»“åº“ / Source Repository:** \`${{ steps.commit-info.outputs.repo_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit SHA:** \`${{ steps.commit-info.outputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**æäº¤ä¿¡æ¯ / Commit Message:** ${{ steps.commit-info.outputs.commit_message }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… å·²åœ¨ \`h66840/my-new-proj\` ä»“åº“ä¸­åˆ›å»ºéƒ¨ç½²é€šçŸ¥issue" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Deployment notification issue created in \`h66840/my-new-proj\` repository" >> $GITHUB_STEP_SUMMARY